"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var pdf_manager_1=require("pdfjs-dist/lib/core/pdf_manager"),primitives_1=require("pdfjs-dist/lib/core/primitives"),stream_1=require("pdfjs-dist/lib/core/stream"),util_1=require("pdfjs-dist/lib/shared/util"),pako_1=require("pako"),queue=require("promise-queue"),PDFAssembler=function(){function PDFAssembler(e,t){void 0===t&&(t="");var r=this;this.pdfManager=null,this.userPassword="",this.ownerPassword="",this.nextNodeNum=1,this.pdfTree=Object.create(null),this.recoveryMode=!1,this.objCache=Object.create(null),this.objCacheQueue=Object.create(null),this.pdfManagerArrays=[],this.pdfAssemblerArrays=[],this.promiseQueue=new queue(1),this.indent=!1,this.compress=!0,this.encrypt=!1,this.groupPages=!0,this.pageGroupSize=16,this.pdfVersion="1.7",t.length&&(this.userPassword=t),"object"==typeof e?e instanceof Blob||e instanceof ArrayBuffer||e instanceof Uint8Array?this.promiseQueue.add(function(){return r.toArrayBuffer(e).then(function(e){return r.pdfManager=new pdf_manager_1.LocalPdfManager(1,e,t,{},"")}).then(function(){return r.pdfManager.ensureDoc("checkHeader",[])}).then(function(){return r.pdfManager.ensureDoc("parseStartXRef",[])}).then(function(){return r.pdfManager.ensureDoc("parse",[r.recoveryMode])}).then(function(){return r.pdfManager.ensureDoc("numPages")}).then(function(){return r.pdfManager.ensureDoc("fingerprint")}).then(function(){r.pdfTree["/Root"]=r.resolveNodeRefs();var e=new primitives_1.Dict;e._map=r.pdfManager.pdfDocument.documentInfo,r.pdfTree["/Info"]=r.resolveNodeRefs(e)||{},delete r.pdfTree["/Info"]["/IsAcroFormPresent"],delete r.pdfTree["/Info"]["/IsXFAPresent"],delete r.pdfTree["/Info"]["/PDFFormatVersion"],r.pdfTree["/Info"]["/Producer"]="(PDF Assembler)",r.pdfTree["/Info"]["/ModDate"]="("+r.toPdfDate()+")",r.flattenPageTree()})}):this.pdfTree=e:this.pdfTree={documentInfo:{},"/Info":{"/Producer":"(PDF Assembler)","/CreationDate":"("+this.toPdfDate()+")","/ModDate":"("+this.toPdfDate()+")"},"/Root":{"/Type":"/Catalog","/Pages":{"/Type":"/Pages","/Count":1,"/Kids":[{"/Type":"/Page","/MediaBox":[0,0,612,792],"/Contents":[],"/Resources":{}}]}}}}return Object.defineProperty(PDFAssembler.prototype,"pdfDocument",{get:function(){var e=this;return this.promiseQueue.add(function(){return Promise.resolve(e.pdfManager&&e.pdfManager.pdfDocument)})},enumerable:!0,configurable:!0}),Object.defineProperty(PDFAssembler.prototype,"numPages",{get:function(){var e=this;return this.promiseQueue.add(function(){return e.flattenPageTree()}),this.promiseQueue.add(function(){return Promise.resolve(e.pdfTree["/Root"]["/Pages"]["/Count"])})},enumerable:!0,configurable:!0}),Object.defineProperty(PDFAssembler.prototype,"pdfObject",{get:function(){var e=this;return this.promiseQueue.add(function(){return Promise.resolve(e.pdfTree)})},enumerable:!0,configurable:!0}),PDFAssembler.prototype.getPDFDocument=function(){var e=this;return this.promiseQueue.add(function(){return Promise.resolve(e.pdfManager&&e.pdfManager.pdfDocument)})},PDFAssembler.prototype.countPages=function(){var e=this;return this.promiseQueue.add(function(){return e.flattenPageTree()}),this.promiseQueue.add(function(){return Promise.resolve(e.pdfTree["/Root"]["/Pages"]["/Count"])})},PDFAssembler.prototype.getPDFStructure=function(){var e=this;return this.promiseQueue.add(function(){return Promise.resolve(e.pdfTree)})},PDFAssembler.prototype.toArrayBuffer=function(n){var e=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Uint8ClampedArray,Float32Array,Float64Array];return n instanceof ArrayBuffer?Promise.resolve(n):e.some(function(e){return n instanceof e})?Promise.resolve(n.buffer):n instanceof Blob?new Promise(function(e,t){var r=new FileReader;r.onload=function(){return e(r.result)},r.onerror=function(){return t(r.error)},r.readAsArrayBuffer(n)}):Promise.resolve(new ArrayBuffer(0))},PDFAssembler.prototype.resolveNodeRefs=function(t,e,r,n){var s=this;if(void 0===t&&(t=this.pdfManager.pdfDocument.catalog.catDict),void 0===n&&(n=!1),t instanceof primitives_1.Ref){var o=t.num+"-"+t.gen;if(void 0===this.objCache[o]){this.objCache[o]=null;var i=this.pdfManager.pdfDocument.xref.fetch(t);this.objCache[o]=this.resolveNodeRefs(i,e,r,n),"object"!=typeof this.objCache[o]||null===this.objCache[o]||this.objCache[o]instanceof Array||Object.assign(this.objCache[o],{num:0,gen:0}),void 0!==this.objCacheQueue[o]&&(Object.keys(this.objCacheQueue[o]).forEach(function(t){return s.objCacheQueue[o][t].forEach(function(e){return e[t]=s.objCache[o]})}),delete this.objCacheQueue[o])}else if(null===this.objCache[o])return void 0===this.objCacheQueue[o]&&(this.objCacheQueue[o]=Object.create(null)),void 0===this.objCacheQueue[o][e]&&(this.objCacheQueue[o][e]=[]),this.objCacheQueue[o][e].push(r),t;return this.objCache[o]}if(t instanceof primitives_1.Name)return"/"+t.name;if("string"==typeof t)return"("+t+")";if(t instanceof Array){var a=this.pdfManagerArrays.indexOf(t);if(-1<a)return this.pdfAssemblerArrays[a];var u=[];return this.pdfManagerArrays.push(t),this.pdfAssemblerArrays.push(u),t.forEach(function(e,t){return u.push(s.resolveNodeRefs(e,t,u,n))}),u}if("object"==typeof t&&null!==t){var f=Object.create(null),c=null,d=t.dict instanceof primitives_1.Dict?t.dict._map:t instanceof primitives_1.Dict?t._map:null;if(d&&Object.keys(d).forEach(function(e){return f["/"+e]=s.resolveNodeRefs(d[e],"/"+e,f,!!d.Contents)}),t instanceof stream_1.DecodeStream||t instanceof stream_1.Stream){var l=[stream_1.FlateStream,stream_1.PredictorStream,stream_1.DecryptStream,stream_1.Ascii85Stream,stream_1.RunLengthStream,stream_1.LZWStream];if("/Image"!==f["/Subtype"]&&l.some(function(e){return t instanceof e})&&(f.stream=t.getBytes(),f["/Filter"]instanceof Array&&1<f["/Filter"].length?f["/Filter"].shift():delete f["/Filter"]),!f.stream){for(var p=0,h=[t,t.stream,t.stream&&t.stream.str,t.str,t.str&&t.str.str];p<h.length;p++){var m=h[p];if(m instanceof stream_1.Stream||m instanceof stream_1.DecryptStream){c=m;break}}c&&(c.reset(),f.stream=c.getBytes())}}if(f.stream&&((n||"/XML"===f["/Subtype"]||f.stream&&f.stream.every(function(e){return e<128}))&&(f.stream=util_1.bytesToString(f.stream)),delete f["/Length"]),t===this.pdfManager.pdfDocument.catalog.catDict){var g=t.objId.slice(0,-1)+"-0";this.objCache[g]=Object.assign(f,{num:this.nextNodeNum++,gen:0})}return f}return t},PDFAssembler.prototype.pad=function(e,t){return("0".repeat(t-1)+parseInt(e,10)).slice(-t)},PDFAssembler.prototype.toPdfDate=function(e){if(void 0===e&&(e=new Date),!(e instanceof Date))return null;var t=e.getTimezoneOffset();return"D:"+e.getFullYear()+this.pad(e.getMonth()+1,2)+this.pad(e.getDate(),2)+this.pad(e.getHours(),2)+this.pad(e.getMinutes(),2)+this.pad(e.getSeconds(),2)+(t<0?"+":"-")+this.pad(Math.abs(Math.trunc(t/60)),2)+"'"+this.pad(Math.abs(t%60),2)+"'"},PDFAssembler.prototype.fromPdfDate=function(n){if("string"!=typeof n)return null;if("("===n[0]&&")"===n[n.length-1]&&(n=n.slice(1,-1)),"D:"!==n.slice(0,2))return null;var e=function(e,t,r){return void 0===r&&(r=0),parseInt(n.slice(e,t),10)+r};return new Date(e(2,6),e(6,8,-1),e(8,10),e(10,12),e(12,14),e(14,16),0)},PDFAssembler.prototype.removeRootEntries=function(r){return this.pdfObject.then(function(t){return Object.keys(t["/Root"]).filter(function(e){return r&&r.length?r.includes(e):!["/Type","/Pages","num","gen"].includes(e)}).forEach(function(e){return delete t["/Root"][e]}),t})},PDFAssembler.prototype.flattenPageTree=function(e,r){var t=this;void 0===e&&(e=this.pdfTree["/Root"]["/Pages"]["/Kids"]),void 0===r&&(r=this.pdfTree["/Root"]["/Pages"]);var n=[];if(e.forEach(function(e){return n=e&&e["/Kids"]?n.concat(t.flattenPageTree(e["/Kids"],e)):n.concat([e])}),["/Resources","/MediaBox","/CropBox","/Rotate"].filter(function(e){return r[e]}).forEach(function(t){n.filter(function(e){return!e[t]}).forEach(function(e){return e[t]=r[t]}),delete r[t]}),e!==this.pdfTree["/Root"]["/Pages"]["/Kids"])return n;this.pdfTree["/Root"]["/Pages"]["/Count"]=n.length,this.pdfTree["/Root"]["/Pages"]["/Kids"]=n},PDFAssembler.prototype.groupPageTree=function(e,t,r){var n;void 0===e&&(e=this.pdfTree["/Root"]["/Pages"]["/Kids"]),void 0===t&&(t=this.pdfTree["/Root"]["/Pages"]),void 0===r&&(r=this.pageGroupSize);var s=[];if(e.length<=r)s=e.map(function(e){return Object.assign(e,{num:0,"/Parent":t})});else{var o=r,i=Math.ceil(e.length/o);e.length>r*r&&(o=(n=[i,o])[0],i=n[1]);for(var a=0;a<i;a++){var u=e.slice(o*a,o*(a+1));if(1===u.length)s.push(Object.assign(u[0],{num:0,"/Parent":t}));else if(1<u.length){var f={};s.push(Object.assign(f,{num:0,"/Type":"/Pages","/Parent":t,"/Count":u.length,"/Kids":this.groupPageTree(u,f,r)}))}}}if(e!==this.pdfTree["/Root"]["/Pages"]["/Kids"])return s;this.pdfTree["/Root"]["/Pages"]["/Count"]=e.length,this.pdfTree["/Root"]["/Pages"]["/Kids"]=s},PDFAssembler.prototype.resetObjectIds=function(t){var r=this;if(void 0===t&&(t=this.pdfTree["/Root"]),t===this.pdfTree["/Root"]&&(this.nextNodeNum=1,this.objCache=[]),!this.objCache.includes(t)){this.objCache.push(t);var n=function(e){return"object"==typeof e&&null!==e&&!r.objCache.includes(e)};if(t instanceof Array)t.filter(n).forEach(function(e){return r.resetObjectIds(e)});else{("number"==typeof t.num||t.stream||["/AcroForm","/MarkInfo","/Metadata","/Names","/Outlines","/StructTreeRoot","/ViewerPreferences","/Catalog","/Pages","/OCG"].includes(t["/Type"]))&&Object.assign(t,{num:this.nextNodeNum++,gen:0}),Object.keys(t).filter(function(e){return n(t[e])}).forEach(function(e){return r.resetObjectIds(t[e])})}}},PDFAssembler.prototype.assemblePdf=function(f){var g=this;return void 0===f&&(f="output.pdf"),this.promiseQueue.add(function(){return new Promise(function(e,t){var d=["\\000","\\001","\\002","\\003","\\004","\\005","\\006","\\007","\\b","\\t","\\n","\\013","\\f","\\r","\\016","\\017","\\020","\\021","\\022","\\023","\\024","\\025","\\026","\\027","\\030","\\031","\\032","\\033","\\034","\\035","\\036","\\037"," ","!",'"',"#","$","%","&","'","\\(","\\)","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","[","\\\\","]","^","_","`","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","{","|","}","~","\\177","\\200","\\201","\\202","\\203","\\204","\\205","\\206","\\207","\\210","\\211","\\212","\\213","\\214","\\215","\\216","\\217","\\220","\\221","\\222","\\223","\\224","\\225","\\226","\\227","\\230","\\231","\\232","\\233","\\234","\\235","\\236","\\237","\\240","¡","¢","£","¤","¥","¦","§","¨","©","ª","«","¬","­","®","¯","°","±","²","³","´","µ","¶","·","¸","¹","º","»","¼","½","¾","¿","À","Á","Â","Ã","Ä","Å","Æ","Ç","È","É","Ê","Ë","Ì","Í","Î","Ï","Ð","Ñ","Ò","Ó","Ô","Õ","Ö","×","Ø","Ù","Ú","Û","Ü","Ý","Þ","ß","à","á","â","ã","ä","å","æ","ç","è","é","ê","ë","ì","í","î","ï","ð","ñ","ò","ó","ô","õ","ö","÷","ø","ù","ú","û","ü","ý","þ","ÿ"],l=g.indent?"number"==typeof g.indent?" ".repeat(g.indent):"string"==typeof g.indent?g.indent:"\t":"",p=g.indent?"\n":"";g.flattenPageTree(),g.groupPageTree(),g.resetObjectIds(),g.pdfTree["/Root"]["/Version"]="/"+g.pdfVersion;var h=[],m=function(t,r,e){void 0===r&&(r=0),void 0===e&&(e=!0),!0===e&&(e=p+l.repeat(r));var n="";if("string"==typeof t){var s=t[0],o=t[t.length-1];if("/"===s){n="/"+t.slice(1).replace(/./g,function(e){return-1==="\0\t\n\f\r #%()/<>[]{}".indexOf(e)?e:"#"+("0"+e.charCodeAt(0).toString(16)).slice(-2)})}else if("("===s&&")"===o){var i=Array.from(util_1.arraysToBytes(t.slice(1,-1))),a=i.map(function(e){return d[e]}).join("");if(a.length<2*i.length)n="("+a+")";else n="<"+i.map(function(e){return("0"+e.toString(16)).slice(-2)}).join("")+">"}else n=t}else if("object"!=typeof t||null===t)n=null==t?"null":!0===t?"true":!1===t?"false":t+"";else if(t instanceof Array){n="["+t.map(function(e,t){return m(e,r+1,!!l||!!t)}).join("")+p+l.repeat(r)+"]"}else if("number"==typeof t.num&&void 0!==h[t.num])n=t.num+" "+t.gen+" R";else{if("number"==typeof t.num&&(h[t.num]=null,n=t.num+" "+t.gen+" obj"+p,void(r=0)!==t.stream)){if(t.stream.length&&g.compress&&!t["/Filter"]){var u=pako_1.deflate(util_1.arraysToBytes([t.stream]));u.length+19<t.stream.length&&(t.stream=u,t["/Filter"]="/FlateDecode")}t["/Length"]=t.stream.length}if(n+="<<"+Object.keys(t).filter(function(e){return"/"===e[0]}).map(function(e){return m(e,r+1)+m(t[e],r+1,l?" ":"")}).join("")+p+l.repeat(r)+">>","number"==typeof t.num){if(void 0!==t.stream)if(t.stream.length){var f=""+n+p+"stream\n",c=p+"endstream\nendobj\n";n=util_1.arraysToBytes([f,t.stream,c])}else n+=p+"stream\nendstream\nendobj\n";else n+=p+"endobj\n";h[t.num]=n,n=t.num+" "+t.gen+" R"}}return(e||(!1===e||["/","[","(","<"].includes(n[0])?"":" "))+n},r=m(g.pdfTree["/Root"],0,!1),n=g.pdfTree["/Info"]&&Object.keys(g.pdfTree["/Info"]).length?m(g.pdfTree["/Info"],0,!1):null,s="%PDF-"+g.pdfVersion+"\n%âãÏÓ\n",o=0,i="xref\n0 "+h.length+"\n0000000000 65535 f \n"+[s].concat(h).filter(function(e){return e}).map(function(e){return("0000000000"+(o+=e.length)+" 00000 n \n").slice(-20)}).slice(0,-1).join(""),a="trailer\n<<"+p+l+"/Root "+r+p+(n?l+"/Info "+n+p:"")+l+"/Size "+h.length+p+">>\nstartxref\n"+o+"\n%%EOF\n",u=util_1.arraysToBytes([s].concat(h.filter(function(e){return e}),[i,a]));switch(f){case"ArrayBuffer":e(u.buffer);break;case"Uint8Array":e(u);break;default:".pdf"!==f.slice(-4)&&(f+=".pdf"),e(new File([u],f,{type:"application/pdf"}))}})})},PDFAssembler.prototype.arraysToBytes=function(e){return util_1.arraysToBytes(e)},PDFAssembler.prototype.bytesToString=function(e){return util_1.bytesToString(e)},PDFAssembler}();exports.PDFAssembler=PDFAssembler;